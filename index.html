/**
 * @license
 * SPDX-License-Identifier: Apache-2.0
*/
/**
 * @lizenz
 * SPDX-License-Identifier: Apache-2.0
*/

// Dies ist eine Medikamenten-Erinnerungs-App, die mit React erstellt wurde.
// Sie ermöglicht es Benutzern, Medikamentenpläne für verschiedene Profile zu verwalten,
// den Medikamentenvorrat zu verfolgen und Alarmeinstellungen anzupassen.
// Alle Daten werden lokal im Browser des Benutzers gespeichert.

import React from 'react';
import ReactDOM from 'react-dom/client';

const { useState, useEffect, useRef } = React;

/**
 * Hilfsfunktion zum Laden des initialen Zustands aus dem localStorage.
 * @param {string} key - Der Schlüssel im localStorage.
 * @param {*} defaultValue - Der Standardwert, falls kein Eintrag gefunden wird.
 * @returns {*} Der geparste Wert aus dem localStorage oder der Standardwert.
 */
const getInitialState = (key, defaultValue) => {
    try {
        const storedValue = localStorage.getItem(key);
        if (storedValue) {
            return JSON.parse(storedValue);
        }
    } catch (error) {
        console.error(`Fehler beim Lesen von '${key}' aus dem localStorage:`, error);
    }
    return defaultValue;
};

/**
 * Parst einen vollständigen Medikamentennamen in Name und Wirkstärke.
 * @param {string} fullName - Der vollständige Name des Medikaments (z.B. "Ibuprofen 400mg").
 * @returns {{name: string, strength: string}} Ein Objekt mit Name und Wirkstärke.
 */
const parseMedName = (fullName) => {
    const parts = fullName.split(' ');
    const strengthIndex = parts.findIndex(part => /\d/.test(part));
    if (strengthIndex > 0) {
        const name = parts.slice(0, strengthIndex).join(' ');
        const strength = parts.slice(strengthIndex).join(' ');
        return { name, strength };
    }
    return { name: fullName, strength: '' };
};

/**
 * Komponente zur Auswahl der Wochentage.
 * @param {{selectedDays: string[], onDayToggle: (day: string) => void}} props - Props der Komponente.
 */
const WeekDaySelector = ({ selectedDays, onDayToggle }) => {
    const days = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
    return (
        <div className="week-day-selector">
            {days.map(day => (
                <button
                    key={day}
                    className={`day-button ${selectedDays.includes(day) ? 'active' : ''}`}
                    onClick={() => onDayToggle(day)}
                    aria-pressed={selectedDays.includes(day)}
                >
                    {day}
                </button>
            ))}
        </div>
    );
};

/**
 * Modales Fenster zur Verwaltung der Einnahmezeiten und -tage für ein Medikament.
 */
const ManageTimesModal = ({ medName, initialSlots, initialDays, onSave, onClose }) => {
    // Zustand für die bearbeitbaren Einnahme-Slots (Zeit und Dosis)
    const [editableSlots, setEditableSlots] = useState(() => {
        const slotsToEdit = (initialSlots && initialSlots.length > 0) ? initialSlots : [{ time: '', dosage: '1' }];
        return slotsToEdit.map((slot, index) => ({ id: Date.now() + index, time: slot.time, dosage: slot.dosage }));
    });
    // Zustand für die ausgewählten Wochentage
    const [days, setDays] = useState(initialDays || ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So']);
    
    const inputsContainerRef = useRef(null);

    // Fügt einen neuen, leeren Einnahme-Slot hinzu
    const handleAddSlot = () => {
        setEditableSlots(prevSlots => [...prevSlots, { id: Date.now(), time: '', dosage: '1' }]);
        // Scrollt automatisch zum neuen Eingabefeld
        setTimeout(() => {
            if (inputsContainerRef.current) {
                inputsContainerRef.current.scrollTop = inputsContainerRef.current.scrollHeight;
            }
        }, 0);
    };
    
    // Setzt den Fokus auf das neue Eingabefeld, nachdem es hinzugefügt wurde
    useEffect(() => {
        if (inputsContainerRef.current) {
            const inputs = inputsContainerRef.current.querySelectorAll('.time-input-row input[type="text"]');
            const lastTimeInput = inputs[inputs.length - 2]; // Fokussiert das Zeit-Eingabefeld
            if (lastTimeInput) {
                lastTimeInput.focus();
            }
        }
    }, [editableSlots.length]);
    
    // Behandelt Änderungen in den Zeit- und Dosis-Eingabefeldern
    const handleSlotChange = (id, field, value) => {
        let formattedValue = value;
        // Automatische Formatierung der Uhrzeit (HH:MM)
        if (field === 'time') {
            const digitsOnly = value.replace(/[^0-9]/g, "");
            const truncatedDigits = digitsOnly.slice(0, 4);
            formattedValue = truncatedDigits;
            if (truncatedDigits.length > 2) {
                formattedValue = `${truncatedDigits.slice(0, 2)}:${truncatedDigits.slice(2)}`;
            }
        } else if (field === 'dosage') { // Validierung für Dosis (nur Zahlen und ein Punkt)
             if (!/^\d*\.?\d*$/.test(value)) {
                return;
            }
            formattedValue = value;
        }
        setEditableSlots(
            editableSlots.map(s => (s.id === id ? { ...s, [field]: formattedValue } : s))
        );
    };
    
    // Schaltet die Auswahl eines Wochentages um
    const handleDayToggleInModal = (day) => {
        const newDays = days.includes(day)
            ? days.filter(d => d !== day)
            : [...days, day];
        const dayOrder = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
        newDays.sort((a,b) => dayOrder.indexOf(a) - dayOrder.indexOf(b));
        setDays(newDays);
    };

    // Entfernt einen Einnahme-Slot
    const handleRemoveSlot = (idToRemove) => {
        if (editableSlots.length > 1) {
            setEditableSlots(editableSlots.filter(t => t.id !== idToRemove));
        } else {
            alert('Es muss mindestens eine Einnahmezeit vorhanden sein.');
        }
    };
    
    // Behandelt das Drücken der Enter-Taste in den Eingabefeldern
    const handleKeyPress = (e, index) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const currentSlot = editableSlots[index];
            if (index === editableSlots.length - 1 && currentSlot.time.trim() && currentSlot.dosage.trim()) {
                handleAddSlot(); // Fügt neue Zeile hinzu
            } else if (index < editableSlots.length - 1) {
                 if (inputsContainerRef.current) {
                    const inputs = inputsContainerRef.current.querySelectorAll('.time-input-row input[type="text"]');
                    const nextInput = inputs[(index + 1) * 2]; // Springt zur nächsten Zeile
                    if (nextInput) {
                        nextInput.focus();
                    }
                }
            }
        }
    };

    // Validiert und speichert die eingegebenen Daten
    const handleSave = () => {
        const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
        const slotsToSave = [];
        const uniqueTimes = new Set();
        
        const filteredSlots = editableSlots.filter(s => s.time.trim() !== '');

        if (filteredSlots.length === 0) {
            alert('Bitte fügen Sie mindestens eine Einnahmezeit hinzu.');
            return;
        }

        for (const slot of filteredSlots) {
            if (!timeRegex.test(slot.time)) {
                alert('Bitte geben Sie für alle Felder eine gültige Uhrzeit im Format HH:MM ein.');
                return;
            }
            if (!slot.dosage || isNaN(parseFloat(slot.dosage)) || parseFloat(slot.dosage) <= 0) {
                 alert(`Bitte geben Sie eine gültige Dosis für die Uhrzeit ${slot.time} ein.`);
                 return;
            }
            if (uniqueTimes.has(slot.time)) {
                alert(`Die Uhrzeit ${slot.time} wurde mehrfach eingegeben.`);
                return;
            }
            uniqueTimes.add(slot.time);
            slotsToSave.push({ time: slot.time, dosage: slot.dosage });
        }

        onSave({
            slots: slotsToSave.sort((a, b) => a.time.localeCompare(b.time)),
            days: days,
        });
    };

    return (
        <div className="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
            <div className="modal-content">
                <h2 id="modal-title" className="modal-title">{medName}</h2>
                <p className="modal-description">Details bearbeiten.</p>
                
                <div className="modal-form">
                     <div className="time-inputs-list" ref={inputsContainerRef}>
                        {editableSlots.map((slot, index) => (
                            <div key={slot.id} className="time-input-row">
                                <div className="time-input-container">
                                    <input
                                        type="text"
                                        placeholder="00:00"
                                        maxLength={5}
                                        className="form-input form-input-small"
                                        value={slot.time}
                                        onChange={(e) => handleSlotChange(slot.id, 'time', e.target.value)}
                                        onKeyPress={(e) => handleKeyPress(e, index)}
                                    />
                                    <span>Uhr</span>
                                </div>
                                <div className="time-input-container">
                                    <input
                                        type="text"
                                        inputMode="decimal"
                                        placeholder="1"
                                        className="form-input form-input-small"
                                        value={slot.dosage}
                                        onChange={(e) => handleSlotChange(slot.id, 'dosage', e.target.value)}
                                        onKeyPress={(e) => handleKeyPress(e, index)}
                                    />
                                     <span>Stk.</span>
                                </div>
                                <button
                                    className="button-delete button-icon-small"
                                    onClick={() => handleRemoveSlot(slot.id)}
                                    aria-label={`Zeit ${slot.time || ''} entfernen`}
                                    disabled={editableSlots.length <= 1 && editableSlots[0].time === ''}
                                >
                                    <i className="fa-solid fa-times"></i>
                                </button>
                            </div>
                        ))}
                    </div>

                    <button className="button button-secondary add-time-button" onClick={handleAddSlot}>
                        <i className="fa-solid fa-plus"></i> Weitere Zeit hinzufügen
                    </button>
                    
                    <div className="form-group">
                        <label>Einnahmetage</label>
                        <WeekDaySelector selectedDays={days} onDayToggle={handleDayToggleInModal} />
                    </div>
                </div>

                <div className="button-group">
                    <button className="button button-secondary" onClick={onClose}>Abbrechen</button>
                    <button className="button button-primary" onClick={handleSave}>Speichern</button>
                </div>
            </div>
        </div>
    );
};
/**
 * Modales Fenster zur Auswahl von Medikamenten aus dem Vorrat (Apotheke).
 */
const MultiSelectModal = ({ pharmacyStock, onClose, onAdd }) => {
    const [selectedMeds, setSelectedMeds] = useState([]);

    const handleToggleMed = (medName) => {
        setSelectedMeds(prev =>
            prev.includes(medName)
                ? prev.filter(name => name !== medName)
                : [...prev, medName]
        );
    };

    const handleAddClick = () => {
        if (selectedMeds.length > 0) {
            onAdd(selectedMeds);
        }
    };

    return (
        <div className="modal-overlay">
            <div className="modal-content">
                <h2 className="modal-title">Medikamente auswählen</h2>
                <p className="modal-description">Wählen Sie ein oder mehrere Medikamente aus Ihrem Vorrat aus.</p>

                <div className="multi-select-list">
                    {pharmacyStock.length > 0 ? (
                        pharmacyStock.map(med => (
                            <label key={med.id} className="checkbox-item">
                                <input
                                    type="checkbox"
                                    checked={selectedMeds.includes(med.name)}
                                    onChange={() => handleToggleMed(med.name)}
                                />
                                <span className="checkbox-custom"></span>
                                <span className="checkbox-label">{med.name}</span>
                            </label>
                        ))
                    ) : (
                        <p className="empty-list-text">Ihr Vorrat ist leer.</p>
                    )}
                </div>

                <div className="button-group">
                    <button className="button button-secondary" onClick={onClose}>Abbrechen</button>
                    <button className="button button-primary" onClick={handleAddClick} disabled={selectedMeds.length === 0}>
                        Hinzufügen ({selectedMeds.length})
                    </button>
                </div>
            </div>
        </div>
    );
};
/**
 * Ansicht "Einnahmeplan", die die Liste der Medikamente des aktuellen Profils anzeigt.
 */
const EinnahmeplanAnsicht = ({ medications, pharmacyStock, addMedication, deleteMedication, updateMedication }) => {
    // Zustand für das Medikament, das gerade bearbeitet wird (im Modal)
    const [editingMed, setEditingMed] = useState(null);
    // Zustand zur Steuerung des "Medikament auswählen"-Modals
    const [isMultiSelectModalOpen, setIsMultiSelectModalOpen] = useState(false);
    // Warteschlange für Medikamente, die aus dem Vorrat hinzugefügt und konfiguriert werden müssen
    const [medsToAddQueue, setMedsToAddQueue] = useState([]);

    // Effekt, der das Konfigurationsmodal für das nächste Medikament in der Warteschlange öffnet
    useEffect(() => {
        if (medsToAddQueue.length > 0 && !editingMed) {
            setEditingMed({ name: medsToAddQueue[0] });
        }
    }, [medsToAddQueue, editingMed]);

    // Speichert die Details (Zeiten, Tage, etc.) aus dem Bearbeitungsmodal
    const handleSaveMedDetails = (details) => {
        if (editingMed.id) { // Bearbeiten eines bestehenden Medikaments
            const medicationToUpdate = medications.find(m => m.id === editingMed.id);
            if (medicationToUpdate) {
                updateMedication({ 
                    ...medicationToUpdate, 
                    intakeSlots: details.slots,
                    intakeDays: details.days,
                });
            }
        } else { // Hinzufügen eines neuen Medikaments aus der Warteschlange
            addMedication(editingMed.name, details);
            setMedsToAddQueue(prev => prev.slice(1)); // Entfernt das bearbeitete Medikament aus der Warteschlange
        }
        setEditingMed(null); // Schließt das Modal
    };
    
    // Schaltet die Einnahmetage direkt in der Listenansicht um
    const handleDayToggle = (medId, day) => {
        const medicationToUpdate = medications.find(m => m.id === medId);
        if (medicationToUpdate) {
            const newDays = medicationToUpdate.intakeDays.includes(day)
                ? medicationToUpdate.intakeDays.filter(d => d !== day)
                : [...medicationToUpdate.intakeDays, day];
            const dayOrder = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            newDays.sort((a,b) => dayOrder.indexOf(a) - dayOrder.indexOf(b));

             const updatedMed = { ...medicationToUpdate, intakeDays: newDays };
             updateMedication(updatedMed);
        }
    };

    return (
        <div className="view">
            {isMultiSelectModalOpen && (
                <MultiSelectModal
                    pharmacyStock={pharmacyStock}
                    onClose={() => setIsMultiSelectModalOpen(false)}
                    onAdd={(selectedMeds) => {
                        setMedsToAddQueue(selectedMeds);
                        setIsMultiSelectModalOpen(false);
                    }}
                />
            )}
            {editingMed && (
                <ManageTimesModal
                    medName={editingMed.name}
                    initialSlots={editingMed.intakeSlots}
                    initialDays={editingMed.intakeDays}
                    onClose={() => {
                        setEditingMed(null);
                        setMedsToAddQueue([]); // Leert die Warteschlange bei Abbruch
                    }}
                    onSave={handleSaveMedDetails}
                />
            )}
            
            <div className="add-med-form">
                 <button 
                    className="button button-primary" 
                    style={{width: '100%', flexGrow: 1}}
                    onClick={() => setIsMultiSelectModalOpen(true)}
                >
                    <i className="fa-solid fa-plus" style={{ marginRight: '8px' }}></i>
                    Medikament hinzufügen
                </button>
            </div>

            {medications.length > 0 ? (
                <ul className="med-list">
                    {medications.map(med => {
                        const { name, strength } = parseMedName(med.name);
                        return (
                             <li key={med.id} className="med-item">
                               <div className="med-info">
                                    <div className="med-header">
                                        <h3>
                                            {name}
                                            <span className="med-strength">
                                                {strength}
                                            </span>
                                        </h3>
                                    </div>
                                    <div className="intake-times">
                                        <i className="fa-regular fa-clock"></i>
                                        <div className="intake-times-chips">
                                            {med.intakeSlots.map((slot, index) => (
                                                <div key={index} className="intake-slot-group">
                                                    <span className="time-chip">{slot.time}</span>
                                                    <span className="time-chip">{`${slot.dosage} Stk.`}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <WeekDaySelector 
                                        selectedDays={med.intakeDays}
                                        onDayToggle={(day) => handleDayToggle(med.id, day)}
                                    />
                                </div>
                                <div className="med-actions">
                                    <button
                                        className="button-delete"
                                        onClick={() => deleteMedication(med.id)}
                                        aria-label={`Lösche ${med.name}`}
                                    >
                                        <i className="fa-solid fa-trash"></i>
                                    </button>
                                     <button 
                                        className="button-icon-small button-edit"
                                        onClick={() => setEditingMed(med)}
                                        aria-label={`Zeiten für ${name} bearbeiten`}
                                     >
                                        <i className="fa-solid fa-pencil"></i>
                                    </button>
                                </div>
                            </li>
                        )
                    })}
                </ul>
            ) : (
                <div className="empty-list">
                    <p>Keine Medikamente hinzugefügt.</p>
                </div>
            )}
        </div>
    );
};

/**
 * Ansicht "Profil", zur Verwaltung der Patientendaten.
 */
const ProfilAnsicht = ({ profiles, activeProfileId, setActiveProfileId, updateProfile, addProfile, deleteProfile }) => {
    const activeProfile = profiles.find(p => p.id === activeProfileId) || profiles[0];
    
    const [isEditing, setIsEditing] = useState(false);
    const [formData, setFormData] = useState(activeProfile);
    const patientNameInputRef = useRef(null);

    // Effekt, der das Formular mit den Daten des aktiven Profils aktualisiert
    useEffect(() => {
        const currentProfile = profiles.find(p => p.id === activeProfileId);
        if (currentProfile) {
            setFormData(currentProfile);
            // Automatischer Wechsel in den Bearbeitungsmodus für neue, leere Profile
            if (currentProfile.patientName === '') {
                setIsEditing(true);
            } else {
                setIsEditing(false);
            }
        }
    }, [activeProfileId, profiles]);
    
    // Fokussiert das Namensfeld bei neuen Profilen
    useEffect(() => {
        if (isEditing && formData.patientName === '') {
            patientNameInputRef.current?.focus();
        }
    }, [isEditing, formData.patientName]);

    // Behandelt Änderungen in den Formularfeldern und formatiert Eingaben (Datum, Telefon)
    const handleInputChange = (e) => {
        const { name, value } = e.target;
        let formattedValue = value;

        if (name === 'dob') {
            const input = value.replace(/\D/g, '').substring(0, 8);
            const day = input.substring(0, 2);
            const month = input.substring(2, 4);
            const year = input.substring(4, 8);

            if (input.length > 4) {
                formattedValue = `${day}.${month}.${year}`;
            } else if (input.length > 2) {
                formattedValue = `${day}.${month}`;
            } else {
                formattedValue = input;
            }
        }

        if (name === 'doctorPhone') {
            const input = value.replace(/\D/g, '').substring(0, 10);
            if (input.length > 8) {
                formattedValue = `${input.substring(0, 3)} ${input.substring(3, 6)} ${input.substring(6, 8)} ${input.substring(8)}`;
            } else if (input.length > 6) {
                formattedValue = `${input.substring(0, 3)} ${input.substring(3, 6)} ${input.substring(6)}`;
            } else if (input.length > 3) {
                formattedValue = `${input.substring(0, 3)} ${input.substring(3)}`;
            } else {
                formattedValue = input;
            }
        }
        
        setFormData(prev => ({ ...prev, [name]: formattedValue }));
    };

    const handleSave = () => {
        if (!formData.patientName.trim()) {
            alert('Der Patientenname darf nicht leer sein.');
            patientNameInputRef.current?.focus();
            return;
        }
        updateProfile(formData);
        setIsEditing(false);
        alert('Profil gespeichert!');
    };
    
    const handleEdit = () => {
        setIsEditing(true);
    };

    const handleDelete = () => {
        deleteProfile(formData.id);
    };

    return (
        <div className="view">
            <div className="profile-form">
                <div className="form-group profile-switcher">
                    <label htmlFor="profile-select">Aktuelles Profil</label>
                    <div className="profile-controls">
                        <div className="select-container">
                             <select
                                id="profile-select"
                                className="select-style"
                                value={activeProfileId}
                                onChange={(e) => setActiveProfileId(Number(e.target.value))}
                                disabled={isEditing}
                            >
                                {profiles.map(p => (
                                    <option key={p.id} value={p.id}>{p.patientName || 'Neues Profil...'}</option>
                                ))}
                            </select>
                        </div>
                         <button
                            className="button button-small"
                            onClick={addProfile}
                            disabled={isEditing}
                            aria-label="Neues Profil hinzufügen"
                        >
                            <i className="fa-solid fa-plus"></i>
                        </button>
                    </div>
                </div>

                <div className="form-group">
                    <label htmlFor="patientName">Patient</label>
                    <input
                        ref={patientNameInputRef}
                        type="text"
                        id="patientName"
                        name="patientName"
                        className="form-input"
                        placeholder="Max Musterman"
                        value={formData.patientName}
                        onChange={handleInputChange}
                        disabled={!isEditing}
                    />
                </div>
                <div className="form-group">
                    <label htmlFor="dob">Geburtsdatum</label>
                    <input
                        type="text"
                        id="dob"
                        name="dob"
                        className="form-input"
                        value={formData.dob}
                        onChange={handleInputChange}
                        disabled={!isEditing}
                        placeholder="00.00.0000"
                    />
                </div>
                <div className="form-group">
                    <label htmlFor="name">Behandelnder Arzt</label>
                    <div className="prefixed-input">
                         <i className="fa-solid fa-user-doctor input-prefix-icon"></i>
                         <span className="input-prefix-text">Dr.med.</span>
                        <input
                            type="text"
                            id="name"
                            name="name"
                            className="form-input doctor-name-input"
                            value={formData.name}
                            onChange={handleInputChange}
                            disabled={!isEditing}
                            onFocus={e => e.target.setSelectionRange(e.target.value.length, e.target.value.length)}
                        />
                    </div>
                </div>
                <div className="form-group">
                    <label htmlFor="doctorPhone">Telefonnummer des Arztes</label>
                    <div className="prefixed-input">
                         <i className="fa-solid fa-phone input-prefix-icon"></i>
                         <span className="input-prefix-text">{`Tel.Nr.`}</span>
                         {isEditing ? (
                            <input
                                type="tel"
                                id="doctorPhone"
                                name="doctorPhone"
                                className="form-input phone-input"
                                value={formData.doctorPhone}
                                onChange={handleInputChange}
                                placeholder="000 000 00 00"
                            />
                        ) : (
                            <a className="form-input phone-input form-input-display" href={`tel:${formData.doctorPhone.replace(/\s/g, '')}`}>
                                {formData.doctorPhone}
                            </a>
                        )}
                    </div>
                </div>
            </div>
            <div className="button-group">
                {!isEditing ? (
                    <>
                        <button className="button button-danger" onClick={handleDelete}>
                            Profil löschen – definitiv
                        </button>
                        <button className="button button-primary" onClick={handleEdit}>
                            Bearbeiten
                        </button>
                    </>
                ) : (
                    <button className="button button-primary" onClick={handleSave}>
                        Speichern
                    </button>
                )}
            </div>
        </div>
    );
};

/**
 * Ansicht "Apotheke", zur Verwaltung des Medikamentenvorrats.
 */
const ApothekeAnsicht = ({ pharmacyStock, addMedToStock, deleteMedFromStock, medications }) => {
    const [newMedName, setNewMedName] = useState('');
    const [newMedStrength, setNewMedStrength] = useState('');
    const [suggestions, setSuggestions] = useState([]);
    const autocompleteContainerRef = useRef(null);
    const medNameInputRef = useRef(null);
    
    // Schließt die Autocomplete-Vorschläge, wenn außerhalb geklickt wird
    useEffect(() => {
        const handleClickOutside = (event) => {
            if (autocompleteContainerRef.current && !autocompleteContainerRef.current.contains(event.target)) {
                setSuggestions([]);
            }
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => {
            document.removeEventListener("mousedown", handleClickOutside);
        };
    }, []);

    // Filtert Vorschläge basierend auf der Eingabe
    const handleInputChange = (e) => {
        const value = e.target.value;
        setNewMedName(value);

        if (value.trim().length > 1) {
            const filteredSuggestions = medications
                .filter(med => med.name.toLowerCase().includes(value.toLowerCase()))
                .map(med => med.name);
            setSuggestions(filteredSuggestions);
        } else {
            setSuggestions([]);
        }
    };

    // Behandelt die Eingabe der Wirkstärke
    const handleStrengthChange = (e) => {
        const value = e.target.value.replace(/\D/g, '');
        setNewMedStrength(value);
    };

    // Füllt die Felder aus, wenn ein Vorschlag angeklickt wird
    const handleSuggestionClick = (suggestion) => {
        const { name, strength } = parseMedName(suggestion);
        const strengthValue = strength.replace(/\D/g, '');
        
        setNewMedName(name);
        setNewMedStrength(strengthValue);
        setSuggestions([]);

        const strengthInput = medNameInputRef.current?.closest('.med-input-fields').querySelector('#medStrength');
        if (strengthInput && strengthValue) {
            strengthInput.focus();
        } else {
            medNameInputRef.current?.focus();
        }
    };
    
    // Fügt ein neues Medikament zum Vorrat hinzu
    const handleAddMed = (e) => {
        e.preventDefault();
        const medName = newMedName.trim();
        if (!medName) {
            alert('Bitte geben Sie einen Medikamentennamen ein.');
            return;
        }

        const fullName = newMedStrength ? `${medName} ${newMedStrength}mg` : medName;

        const isDuplicate = pharmacyStock.some(
            med => med.name.toLowerCase() === fullName.toLowerCase()
        );
        if (isDuplicate) {
            alert('Dieses Medikament ist bereits in Ihrem Vorrat vorhanden.');
            return;
        }

        addMedToStock(fullName);
        setNewMedName('');
        setNewMedStrength('');
        medNameInputRef.current?.focus();
    };

    return (
        <div className="view">
            <form className="add-med-form" onSubmit={handleAddMed}>
                <div className="add-med-controls">
                    <div className="med-input-fields">
                        <div className="autocomplete-container" ref={autocompleteContainerRef}>
                            <input
                                ref={medNameInputRef}
                                id="medName"
                                type="text"
                                className="form-input"
                                placeholder="Medikamentenname"
                                value={newMedName}
                                onChange={handleInputChange}
                                autoComplete="off"
                                required
                            />
                            {suggestions.length > 0 && (
                                <ul className="suggestions-list">
                                    {suggestions.map((s, index) => (
                                        <li key={index} className="suggestion-item" onClick={() => handleSuggestionClick(s)}>
                                            {s}
                                        </li>
                                    ))}
                                </ul>
                            )}
                        </div>
                        <div className="strength-input-container">
                            <input
                                id="medStrength"
                                type="text"
                                inputMode="numeric"
                                className="form-input"
                                placeholder="Wirkstärke"
                                value={newMedStrength}
                                onChange={handleStrengthChange}
                            />
                            <span>mg</span>
                        </div>
                    </div>
                    <button type="submit" className="button button-small" aria-label="Medikament hinzufügen">
                        <i className="fa-solid fa-plus"></i>
                    </button>
                </div>
            </form>

            <div className="pharmacy-stock">
                <div className="pharmacy-controls">
                    <h2>Ihr Vorrat</h2>
                </div>
                {pharmacyStock.length > 0 ? (
                    <ul className="med-list">
                        {pharmacyStock.map(med => (
                            <li key={med.id} className="med-item pharmacy-item">
                                <span style={{ flexGrow: 1 }}>{med.name}</span>
                                <button className="button-delete" onClick={() => deleteMedFromStock(med.id)} aria-label={`Lösche ${med.name}`}>
                                    <i className="fa-solid fa-trash"></i>
                                </button>
                            </li>
                        ))}
                    </ul>
                ) : (
                    <div className="empty-list">
                        <p>Keine Medikamente im Vorrat.</p>
                    </div>
                )}
            </div>
        </div>
    );
};

/**
 * Ansicht "Einstellungen", zur Konfiguration der App (Dunkelmodus, Erinnerungen, Alarmton, Backup).
 */
const EinstellungenAnsicht = ({ settings, updateSettings, restoreData }) => {
    const handleSoundUpload = (event) => {
        const file = event.target.files[0];
        if (file && file.type === 'audio/mpeg') {
            const reader = new FileReader();
            reader.onload = (e) => {
                // FIX: The type of e.target.result is `string | ArrayBuffer | null`. Since `readAsDataURL` is used, the result is a string. Cast to `string` to satisfy TypeScript.
                updateSettings({
                    ...settings,
                    notificationSound: e.target.result as string,
                    soundFileName: file.name
                });
            };
            reader.readAsDataURL(file);
        } else {
            alert('Bitte wählen Sie eine gültige MP3-Datei aus.');
        }
    };

    const removeSound = () => {
        updateSettings({
            ...settings,
            notificationSound: null,
            soundFileName: null
        });
    };

    const handleBackup = async () => {
        try {
            const backupData = {
                profiles: getInitialState('profiles', []),
                activeProfileId: getInitialState('activeProfileId', 1),
                pharmacyStock: getInitialState('pharmacyStock', []),
                settings: getInitialState('settings', {}),
            };

            const jsonString = JSON.stringify(backupData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const date = new Date().toISOString().slice(0, 10);
            const suggestedName = `medi-manager-backup-${date}.json`;

            // Modern "Save As" API using showSaveFilePicker
            if ('showSaveFilePicker' in window) {
                try {
                    const handle = await (window as any).showSaveFilePicker({
                        suggestedName: suggestedName,
                        types: [{
                            description: 'JSON-Dateien',
                            accept: { 'application/json': ['.json'] },
                        }],
                    });
                    const writable = await handle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                } catch (err) {
                    // Silently catch user cancellation (AbortError)
                    if ((err as DOMException).name !== 'AbortError') {
                        console.error("Backup failed using File System Access API:", err);
                        alert("Das Backup konnte nicht erstellt werden.");
                    }
                }
            } else {
                // Fallback for older browsers
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = suggestedName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        } catch (error) {
            console.error("Backup failed:", error);
            alert("Das Backup konnte nicht erstellt werden.");
        }
    };

    const handleRestore = (event) => {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const text = e.target.result;
                const data = JSON.parse(text as string);

                if (data.profiles && data.pharmacyStock && data.settings && data.activeProfileId) {
                    if (confirm("Sind Sie sicher, dass Sie die Sicherung wiederherstellen möchten? Alle aktuellen Daten werden überschrieben.")) {
                        restoreData(data);
                    }
                } else {
                    alert("Die ausgewählte Datei scheint keine gültige Sicherung zu sein.");
                }
            } catch (error) {
                console.error("Restore failed:", error);
                alert("Fehler beim Lesen der Sicherungsdatei. Bitte stellen Sie sicher, dass es sich um eine gültige Backup-Datei handelt.");
            }
        };
        reader.readAsText(file);
        event.target.value = null; // Reset input for same-file selection
    };

    return (
        <div className="view">
             <div className="setting-item">
                <label className="setting-label">Erinnerungen</label>
                <label className="switch">
                    <input
                        type="checkbox"
                        checked={settings.remindersEnabled}
                        onChange={() => updateSettings({ ...settings, remindersEnabled: !settings.remindersEnabled })}
                    />
                    <span className="slider"></span>
                </label>
            </div>
            <div className="setting-item">
                <label className="setting-label">Dunkelmodus</label>
                <label className="switch">
                    <input
                        type="checkbox"
                        checked={settings.darkMode}
                        onChange={() => updateSettings({ ...settings, darkMode: !settings.darkMode })}
                    />
                    <span className="slider"></span>
                </label>
            </div>
            <div className="setting-item setting-item-column">
                <label className="setting-label">Alarmton</label>
                {settings.soundFileName ? (
                     <div className="file-upload-controls">
                        <span className="file-info">{settings.soundFileName}</span>
                        <button className="button-delete button-icon-small" onClick={removeSound} aria-label="Alarmton entfernen">
                            <i className="fa-solid fa-times"></i>
                        </button>
                    </div>
                ) : (
                    <div className="file-upload-controls">
                        <label htmlFor="sound-upload" className="file-upload-label">
                             <i className="fa-solid fa-upload"></i> MP3 hochladen
                        </label>
                        <input id="sound-upload" type="file" accept=".mp3" onChange={handleSoundUpload} />
                    </div>
                )}
            </div>
            <div className="backup-restore-section">
                <div className="form-group">
                     <label>Datensicherung</label>
                     <div className="button-group" style={{marginTop: '4px'}}>
                        <button className="button button-secondary" onClick={handleBackup}>
                            <i className="fa-solid fa-download" style={{ marginRight: '8px' }}></i>
                            Backup erstellen
                        </button>
                        <label htmlFor="restore-upload" className="button button-secondary">
                             <i className="fa-solid fa-upload" style={{ marginRight: '8px' }}></i>
                             Backup laden
                        </label>
                        <input id="restore-upload" type="file" accept=".json" onChange={handleRestore} style={{ display: 'none' }} />
                     </div>
                </div>
            </div>
        </div>
    );
};

/**
 * Modales Alarm-Fenster, das bei fälligen Medikamenten angezeigt wird.
 */
const AlarmModal = ({ medsDue, onClose, settings }) => {
    const audioRef = useRef(null);

    useEffect(() => {
        const audioElement = document.getElementById('alarm-sound');
        if (audioElement) {
            audioRef.current = audioElement;
            if (settings.notificationSound) {
                audioRef.current.src = settings.notificationSound;
            } else {
                audioRef.current.removeAttribute('src');
            }
            
            const playPromise = audioRef.current.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.error("Audio playback failed:", error);
                });
            }
        }

        return () => {
            if (audioRef.current) {
                audioRef.current.pause();
                audioRef.current.currentTime = 0;
            }
        };
    }, [settings.notificationSound]);

    return (
        <div className="alarm-modal-overlay">
            <div className="alarm-modal-content">
                <div className="blinking-alarm-header">
                    <i className="fa-solid fa-bell"></i>
                    <h2>Erinnerung</h2>
                </div>
                <ul className="alarm-med-list">
                    {medsDue.map((medText, index) => (
                        <li key={index} className="alarm-med-item">{medText}</li>
                    ))}
                </ul>
                <button className="button button-confirm-intake" onClick={onClose}>
                    Einnahme bestätigen
                </button>
                <p className="alarm-info">Es ist Zeit für Ihre Medikamente.</p>
            </div>
        </div>
    );
};

/**
 * Haupt-App-Komponente.
 * Verwaltet den gesamten Anwendungszustand, einschließlich Profile, Medikamente,
 * Einstellungen und die aktive Ansicht. Enthält die Logik für
 * die Datenspeicherung im localStorage.
 */
const App = () => {
    // Zustand für die Profile der Benutzer, wird aus dem localStorage initialisiert
    const [profiles, setProfiles] = useState(() => {
        const storedProfiles = getInitialState('profiles', null);

        if (!storedProfiles) {
            return [{ id: 1, patientName: 'Max Musterman', dob: '01.01.1970', name: '', doctorPhone: '', medications: [] }];
        }
        
        // Datenmigration für ältere Versionen, die Medikamente separat speicherten
        const needsMigration = storedProfiles.length > 0 && !('medications' in storedProfiles[0]);

        if (needsMigration) {
            const migratedProfiles = storedProfiles.map(profile => {
                const oldMedications = getInitialState(`medications_${profile.id}`, []);
                localStorage.removeItem(`medications_${profile.id}`);
                return { ...profile, medications: oldMedications };
            });
            localStorage.setItem('profiles', JSON.stringify(migratedProfiles));
            return migratedProfiles;
        }
        
        return storedProfiles;
    });
    // Zustand für die ID des aktiven Profils
    const [activeProfileId, setActiveProfileId] = useState(() => getInitialState('activeProfileId', 1));
    // Zustand für den Medikamentenvorrat (Apotheke)
    const [pharmacyStock, setPharmacyStock] = useState(() => getInitialState('pharmacyStock', []));
    
    // Zustand für die App-Einstellungen (Dunkelmodus, Erinnerungen)
    const [settings, setSettings] = useState(() => {
        const defaultSettings = {
            darkMode: false,
            remindersEnabled: true,
            notificationSound: null,
            soundFileName: null,
        };
        return getInitialState('settings', defaultSettings);
    });
    
    // Zustand für die aktuell angezeigte Ansicht ('profil', 'plan', etc.)
    const [activeView, setActiveView] = useState('profil');
        
    // Zustand für den aktiven In-App-Alarm
    const [activeAlarm, setActiveAlarm] = useState(null);
    const [triggeredAlarms, setTriggeredAlarms] = useState(() => getInitialState('triggeredAlarms', {}));
        
    // Abgeleiteter Zustand: Medikamente für das aktuell aktive Profil
    const activeProfile = profiles.find(p => p.id === activeProfileId) || profiles[0] || { medications: [] };
    const medications = activeProfile.medications;

    // Effekte, die den Zustand bei Änderungen in den localStorage schreiben
    useEffect(() => localStorage.setItem('profiles', JSON.stringify(profiles)), [profiles]);
    useEffect(() => localStorage.setItem('activeProfileId', JSON.stringify(activeProfileId)), [activeProfileId]);
    useEffect(() => localStorage.setItem('pharmacyStock', JSON.stringify(pharmacyStock)), [pharmacyStock]);
    useEffect(() => localStorage.setItem('settings', JSON.stringify(settings)), [settings]);
    useEffect(() => localStorage.setItem('triggeredAlarms', JSON.stringify(triggeredAlarms)), [triggeredAlarms]);

    // Effekt zur Registrierung des Service Workers und Anforderung von Berechtigungen
    useEffect(() => {
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registriert:', registration);
                        if (Notification.permission === 'default') {
                            Notification.requestPermission();
                        }
                    })
                    .catch(error => {
                        console.error('Fehler bei der Service Worker-Registrierung:', error);
                    });
            });
        }
    }, []);

    // Effekt zur Synchronisierung der Pläne mit dem Service Worker (für Hintergrund-Benachrichtigungen)
    useEffect(() => {
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(registration => {
                registration.active.postMessage({
                    type: 'UPDATE_SCHEDULES',
                    schedules: settings.remindersEnabled ? medications : []
                });
            }).catch(error => console.error("Service Worker ist nicht bereit:", error));
        }
    }, [medications, settings.remindersEnabled]);
    
    // Effekt für die In-App-Alarmprüfung
    useEffect(() => {
        if (!settings.remindersEnabled) {
            return;
        }

        const intervalId = setInterval(() => {
            const now = new Date();
            const currentDayName = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'][now.getDay()];
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            const todayKey = `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;
            
            // Tracker um Mitternacht zurücksetzen
            if (currentTime === '00:00') {
                const newTriggered = {};
                Object.keys(triggeredAlarms).forEach(key => {
                    if (key.startsWith(todayKey)) {
                        newTriggered[key] = triggeredAlarms[key];
                    }
                });
                setTriggeredAlarms(newTriggered);
            }

            if (!activeProfile || !activeProfile.medications || activeAlarm) return;

            const medsDueNow = [];
            activeProfile.medications.forEach(med => {
                if (med.intakeDays.includes(currentDayName)) {
                    med.intakeSlots.forEach(slot => {
                        const alarmId = `${todayKey}-${med.id}-${slot.time}`;
                        if (slot.time === currentTime && !triggeredAlarms[alarmId]) {
                            medsDueNow.push(`${med.name} (${slot.dosage} Stk.)`);
                            setTriggeredAlarms(prev => ({ ...prev, [alarmId]: true }));
                        }
                    });
                }
            });
            
            if (medsDueNow.length > 0) {
                setActiveAlarm(medsDueNow);
            }
        }, 5000); // Prüfung alle 5 Sekunden

        return () => clearInterval(intervalId);

    }, [medications, settings.remindersEnabled, activeProfile, triggeredAlarms, activeAlarm]);

    // Effekt zur Umschaltung des Dunkelmodus durch Ändern von CSS-Variablen
    useEffect(() => {
        const root = document.documentElement;
        const metaThemeColor = document.querySelector('meta[name="theme-color"]');
        if (settings.darkMode) {
            root.style.setProperty('--base-bg-color', '#2a2f3a');
            root.style.setProperty('--text-color', '#e0e5ec');
            root.style.setProperty('--text-color-light', '#a3b1c6');
            root.style.setProperty('--shadow-light', '#343a45');
            root.style.setProperty('--shadow-dark', '#202530');
            root.style.setProperty('--border-color', '#343a45');
            root.style.setProperty('--disabled-bg-color', '#343a45');
            root.style.setProperty('--switch-thumb-bg', '#e0e5ec');
            root.style.setProperty('--small-switch-thumb-bg', 'linear-gradient(145deg, #2d323e, #262a34)');
             root.style.setProperty('--nav-bar-shadow', '0 -4px 12px rgba(0, 0, 0, 0.3)');
            if (metaThemeColor) metaThemeColor.setAttribute('content', '#2a2f3a');
        } else {
            root.style.setProperty('--base-bg-color', '#e0e5ec');
            root.style.setProperty('--text-color', '#5a6473');
            root.style.setProperty('--text-color-light', '#606e85');
            root.style.setProperty('--shadow-light', '#ffffff');
            root.style.setProperty('--shadow-dark', '#a3b1c6');
            root.style.setProperty('--border-color', '#d1d9e6');
            root.style.setProperty('--disabled-bg-color', '#d1d9e6');
            root.style.setProperty('--switch-thumb-bg', 'white');
            root.style.setProperty('--small-switch-thumb-bg', 'linear-gradient(145deg, #f0f2f5, #c8d0e7)');
            root.style.setProperty('--nav-bar-shadow', '0 -4px 12px rgba(0, 0, 0, 0.1)');
            if (metaThemeColor) metaThemeColor.setAttribute('content', '#e0e5ec');
        }
    }, [settings.darkMode]);

    // Hilfsfunktion zum Aktualisieren der Medikamentenliste des aktiven Profils
    const updateActiveProfileMedications = (newMedications) => {
        setProfiles(currentProfiles =>
            currentProfiles.map(p =>
                p.id === activeProfileId ? { ...p, medications: newMedications } : p
            )
        );
    };

    // --- Wiederherstellungsfunktion ---
    const restoreData = (data) => {
        try {
            localStorage.setItem('profiles', JSON.stringify(data.profiles || []));
            localStorage.setItem('activeProfileId', JSON.stringify(data.activeProfileId || 1));
            localStorage.setItem('pharmacyStock', JSON.stringify(data.pharmacyStock || []));
            localStorage.setItem('settings', JSON.stringify(data.settings || {}));

            alert("Sicherung erfolgreich wiederhergestellt. Die App wird neu geladen.");
            window.location.reload();
        } catch (error) {
            console.error("Error during data restore:", error);
            alert("Ein Fehler ist bei der Wiederherstellung aufgetreten.");
        }
    };

    // --- Medikamenten-Verwaltung ---
    const addMedication = (medName, details) => {
        const newMed = {
            id: Date.now(),
            name: medName,
            intakeSlots: details.slots,
            intakeDays: details.days,
        };
        const currentMedications = (profiles.find(p => p.id === activeProfileId) || { medications: [] }).medications;
        updateActiveProfileMedications([...currentMedications, newMed]);
    };

    const deleteMedication = (id) => {
        const currentMedications = (profiles.find(p => p.id === activeProfileId) || { medications: [] }).medications;
        updateActiveProfileMedications(currentMedications.filter(m => m.id !== id));
    };

    const updateMedication = (updatedMed) => {
         const currentMedications = (profiles.find(p => p.id === activeProfileId) || { medications: [] }).medications;
        updateActiveProfileMedications(currentMedications.map(m => (m.id === updatedMed.id ? updatedMed : m)));
    };
    
    // --- Apotheken-Vorrat-Verwaltung ---
    const addMedToStock = (medName) => {
        const newMed = { id: Date.now(), name: medName };
        setPharmacyStock(prev => [...prev, newMed].sort((a, b) => a.name.localeCompare(b.name)));
    };

    const deleteMedFromStock = (id) => {
        setPharmacyStock(pharmacyStock.filter(m => m.id !== id));
    };

    // --- Profil-Verwaltung ---
    const addProfile = () => {
        const newProfileId = Date.now();
        const newProfile = { id: newProfileId, patientName: '', dob: '', name: '', doctorPhone: '', medications: [] };
        setProfiles(prev => [...prev, newProfile]);
        setActiveProfileId(newProfileId);
    };

    const updateProfile = (updatedProfile) => {
        setProfiles(profiles.map(p => p.id === updatedProfile.id ? updatedProfile : p));
    };
    
    const deleteProfile = (id) => {
        if (profiles.length <= 1) {
            alert("Das letzte Profil kann nicht gelöscht werden.");
            return;
        }
        if (confirm("Sind Sie sicher, dass Sie dieses Profil und alle zugehörigen Medikamentenpläne löschen möchten?")) {
            const remainingProfiles = profiles.filter(p => p.id !== id);
            setProfiles(remainingProfiles);
            setActiveProfileId(remainingProfiles[0].id);
        }
    };
    
    // Rendert die aktive Ansicht basierend auf dem `activeView`-Zustand
    const renderView = () => {
        switch (activeView) {
            case 'plan':
                return <EinnahmeplanAnsicht
                            medications={medications}
                            pharmacyStock={pharmacyStock.filter(stockMed => !medications.some(planMed => planMed.name === stockMed.name))}
                            addMedication={addMedication}
                            deleteMedication={deleteMedication}
                            updateMedication={updateMedication}
                        />;
            case 'apotheke':
                return <ApothekeAnsicht 
                            pharmacyStock={pharmacyStock}
                            addMedToStock={addMedToStock}
                            deleteMedFromStock={deleteMedFromStock}
                            medications={[...medications, ...pharmacyStock]}
                        />;
            case 'profil':
                return <ProfilAnsicht 
                            profiles={profiles}
                            activeProfileId={activeProfileId}
                            setActiveProfileId={setActiveProfileId}
                            updateProfile={updateProfile}
                            addProfile={addProfile}
                            deleteProfile={deleteProfile}
                        />;
            case 'einstellungen':
                return <EinstellungenAnsicht 
                            settings={settings}
                            updateSettings={setSettings}
                            restoreData={restoreData}
                       />;
            default:
                return null;
        }
    };
    
    // Gibt das passende Icon und den Titel für den Header der aktuellen Ansicht zurück
    const getHeaderInfo = () => {
        switch(activeView) {
            case 'plan': return { icon: 'fa-solid fa-pills', title: 'Einnahmeplan' };
            case 'apotheke': return { icon: 'fa-solid fa-mortar-pestle', title: 'Apotheke' };
            case 'profil': return { icon: 'fa-solid fa-user', title: 'Patientenprofil' };
            case 'einstellungen': return { icon: 'fa-solid fa-gear', title: 'Einstellungen' };
            default: return { icon: '', title: '' };
        }
    };
    
    const { icon, title } = getHeaderInfo();

    return (
        <>
            <div className="app-container">
                {activeView === 'profil' && (
                    <div className="brand-header">
                        <i className="fa-solid fa-pills"></i>
                        <h2 className="main-app-title">Medi-Manager</h2>
                    </div>
                )}
                <div className="app-header">
                    <div className="header-icon"><i className={icon}></i></div>
                    <h1>{title}</h1>
                </div>

                {renderView()}

                <nav className="nav-bar">
                    <button className={`nav-item ${activeView === 'profil' ? 'active' : ''}`} onClick={() => setActiveView('profil')} aria-label="Profil"><i className="fa-solid fa-user"></i></button>
                    <button className={`nav-item ${activeView === 'plan' ? 'active' : ''}`} onClick={() => setActiveView('plan')} aria-label="Einnahmeplan"><i className="fa-solid fa-pills"></i></button>
                    <button className={`nav-item ${activeView === 'apotheke' ? 'active' : ''}`} onClick={() => setActiveView('apotheke')} aria-label="Apotheke"><i className="fa-solid fa-mortar-pestle"></i></button>
                    <button className={`nav-item ${activeView === 'einstellungen' ? 'active' : ''}`} onClick={() => setActiveView('einstellungen')} aria-label="Einstellungen"><i className="fa-solid fa-gear"></i></button>
                </nav>
            </div>
            {activeAlarm && (
                <AlarmModal 
                    medsDue={activeAlarm} 
                    onClose={() => setActiveAlarm(null)} 
                    settings={settings} 
                />
            )}
        </>
    );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
